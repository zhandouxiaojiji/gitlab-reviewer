# 定时拉取功能说明

## 功能概述

系统已实现后端定时拉取功能，替代了前端的拉取限制。现在系统会自动从GitLab拉取commit和评论数据，并保存到本地JSON文件中。

## 主要特性

### 1. 自动定时拉取
- **Commit拉取**: 每5分钟自动拉取一次所有项目的commit数据
- **评论拉取**: 每10秒自动拉取一次commit的评论数据
- **增量拉取**: 只拉取上次拉取时间之后的新数据，提高效率

### 2. 本地数据存储
- 数据保存在 `server/data/` 目录下
- 每个项目的commit数据单独存储为 `commits_[projectId].json`
- 包含完整的commit信息和评论数据

### 3. 手动刷新功能
- 提供手动刷新API接口：`POST /api/gitlab/projects/:projectId/sync`
- 可以立即触发指定项目的数据拉取
- 前端可以添加"刷新"按钮调用此接口

## 数据结构

### Commit数据格式
```json
{
  "projectId": "项目ID",
  "lastCommitPullTime": "最后commit拉取时间",
  "lastCommentPullTime": "最后评论拉取时间",
  "commits": [
    {
      "id": "commit完整ID",
      "short_id": "commit短ID",
      "message": "提交信息",
      "author_name": "作者姓名",
      "author_email": "作者邮箱",
      "committed_date": "提交时间",
      "web_url": "GitLab链接",
      "has_comments": "是否有评论",
      "comments_count": "评论数量",
      "skip_review": "是否跳过审查（基于过滤规则）",
      "comments": "评论详情数组"
    }
  ]
}
```

## API变更

### 1. 获取Commit列表
- **接口**: `GET /api/gitlab/projects/:projectId/commits`
- **变更**: 现在从本地JSON文件读取数据，不再实时调用GitLab API
- **优势**: 响应速度快，不受GitLab API限制影响

### 2. 手动同步数据
- **接口**: `POST /api/gitlab/projects/:projectId/sync`
- **功能**: 手动触发指定项目的commit和评论拉取
- **用途**: 用户需要立即查看最新数据时使用

## 服务器启动流程

1. 服务器启动时自动初始化定时任务
2. 立即执行一次全量拉取
3. 启动定时任务：
   - Commit拉取任务（5分钟间隔）
   - 评论拉取任务（10秒间隔）
4. 服务器关闭时自动停止所有定时任务

## 性能优化

### 1. 增量拉取策略
- 记录每个项目的最后拉取时间
- 只拉取指定时间之后的新commit
- 避免重复拉取已有数据

### 2. 智能评论拉取
- 只对没有评论或评论可能更新的commit拉取评论
- 已确定有评论的commit不会重复拉取
- 减少不必要的API调用

### 3. 错误处理
- 单个项目拉取失败不影响其他项目
- 网络错误时自动重试
- 详细的错误日志记录

## 配置说明

### 拉取间隔配置
可以在 `schedulerService.ts` 中修改拉取间隔：
- `commitPullInterval`: commit拉取间隔（默认5分钟）
- `commentPullInterval`: 评论拉取间隔（默认10秒）

### 数据存储路径
- 默认存储在 `server/data/` 目录
- 可以通过修改 `DATA_DIR` 常量更改存储路径

## 使用建议

1. **首次使用**: 启动服务器后等待几分钟，让系统完成初始数据拉取
2. **数据更新**: 正常情况下数据会自动更新，无需手动操作
3. **立即刷新**: 如需查看最新数据，可使用手动同步功能
4. **监控日志**: 查看服务器日志了解拉取状态和可能的错误

## 故障排除

### 常见问题
1. **数据为空**: 检查项目配置是否正确，GitLab访问令牌是否有效
2. **拉取失败**: 查看服务器日志，检查网络连接和GitLab服务状态
3. **数据不更新**: 确认定时任务是否正常运行，检查项目是否设置为活跃状态

### 日志查看
服务器会输出详细的拉取日志，包括：
- 拉取开始和完成时间
- 拉取的commit数量
- 错误信息和警告
- 各项目的拉取状态 